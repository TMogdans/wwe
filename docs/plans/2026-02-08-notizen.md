# Notizen (`>`) Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Support note lines (starting with `>`) in Cooklang recipes — parsed, serialized, displayed differently from steps, and editable in TipTap.

**Architecture:** Notes are lines starting with `>`. They can contain Cooklang tokens (ingredients, timers, etc.). We model them as steps with an `isNote: true` flag on `CooklangStep`, so existing token handling works. In the frontend, notes render as blockquote-style blocks and are excluded from step numbering in cook mode.

**Tech Stack:** TypeScript, Vitest, TipTap (ProseMirror), React, CSS

---

### Task 1: Add `isNote` flag to `CooklangStep` type

**Files:**
- Modify: `packages/backend/src/parser/types.ts:28-30`

**Step 1: Add `isNote` to `CooklangStep`**

In `packages/backend/src/parser/types.ts`, change:

```typescript
export interface CooklangStep {
	tokens: CooklangToken[];
}
```

to:

```typescript
export interface CooklangStep {
	tokens: CooklangToken[];
	isNote?: boolean;
}
```

**Step 2: Commit**

```bash
git add packages/backend/src/parser/types.ts
git commit -m "feat: add isNote flag to CooklangStep type"
```

---

### Task 2: Write failing parser tests for notes

**Files:**
- Modify: `packages/backend/src/parser/__tests__/parser.test.ts`

**Step 1: Write the failing tests**

Add to `packages/backend/src/parser/__tests__/parser.test.ts`:

```typescript
it("parses a note line", () => {
	const input = "> Dieses Rezept stammt aus Omas Kochbuch.";
	const recipe = parseRecipe(input);
	expect(recipe.sections[0].steps).toHaveLength(1);
	expect(recipe.sections[0].steps[0].isNote).toBe(true);
	expect(recipe.sections[0].steps[0].tokens).toEqual([
		{ type: "text", value: "Dieses Rezept stammt aus Omas Kochbuch." },
	]);
});

it("parses note with cooklang tokens", () => {
	const input = "> Tipp: @Butter{50%g} vorher schmelzen.";
	const recipe = parseRecipe(input);
	expect(recipe.sections[0].steps[0].isNote).toBe(true);
	expect(recipe.sections[0].steps[0].tokens).toEqual([
		{ type: "text", value: "Tipp: " },
		{ type: "ingredient", name: "Butter", amount: "50", unit: "g" },
		{ type: "text", value: " vorher schmelzen." },
	]);
});

it("distinguishes notes from regular steps", () => {
	const input = `> Hinweis zum Rezept.

@Mehl{500%g} in eine Schüssel geben.`;
	const recipe = parseRecipe(input);
	expect(recipe.sections[0].steps).toHaveLength(2);
	expect(recipe.sections[0].steps[0].isNote).toBe(true);
	expect(recipe.sections[0].steps[1].isNote).toBeUndefined();
});

it("parses note within a section", () => {
	const input = `= Teig

> Am besten den Teig am Vortag vorbereiten.

@Mehl{500%g} verrühren.`;
	const recipe = parseRecipe(input);
	expect(recipe.sections[0].steps).toHaveLength(2);
	expect(recipe.sections[0].steps[0].isNote).toBe(true);
	expect(recipe.sections[0].steps[1].isNote).toBeUndefined();
});

it("does not confuse >> metadata with > note", () => {
	const input = `>> servings: 4

> Eine kleine Notiz.`;
	const recipe = parseRecipe(input);
	expect(recipe.metadata.servings).toBe("4");
	expect(recipe.sections[0].steps).toHaveLength(1);
	expect(recipe.sections[0].steps[0].isNote).toBe(true);
});
```

**Step 2: Run tests to verify they fail**

Run: `cd packages/backend && npx vitest run src/parser/__tests__/parser.test.ts`
Expected: FAIL — `isNote` will be `undefined` for note lines because they're parsed as regular steps.

**Step 3: Commit**

```bash
git add packages/backend/src/parser/__tests__/parser.test.ts
git commit -m "test: add failing parser tests for note lines"
```

---

### Task 3: Implement note parsing in parser

**Files:**
- Modify: `packages/backend/src/parser/parser.ts`

**Step 1: Add note detection after the `>>` metadata check**

In `packages/backend/src/parser/parser.ts`, after the `>>` metadata block and before the empty-line check, add note detection. The relevant insertion point is after the `>>` handling `continue` and before `if (trimmed === "")`:

```typescript
// Detect note lines: > (but not >>)
if (trimmed.startsWith(">") && !trimmed.startsWith(">>")) {
	const noteContent = trimmed.slice(1).trim();
	const result = tokenizeLine(noteContent);
	currentSection.steps.push({ tokens: result.tokens, isNote: true });
	continue;
}
```

This must be placed right after the `>>` metadata handling block (after its `continue`), before `if (trimmed === "")`.

**Step 2: Run tests to verify they pass**

Run: `cd packages/backend && npx vitest run src/parser/__tests__/parser.test.ts`
Expected: All tests PASS

**Step 3: Commit**

```bash
git add packages/backend/src/parser/parser.ts
git commit -m "feat: parse note lines starting with >"
```

---

### Task 4: Write failing serializer tests for notes

**Files:**
- Modify: `packages/backend/src/parser/__tests__/serializer.test.ts`

**Step 1: Write the failing tests**

Add to `packages/backend/src/parser/__tests__/serializer.test.ts`:

```typescript
it("serializes a note step", () => {
	const recipe = {
		metadata: {},
		sections: [
			{
				name: "",
				steps: [
					{
						tokens: [
							{ type: "text" as const, value: "Hinweis zum Rezept." },
						],
						isNote: true,
					},
				],
			},
		],
	};
	const output = serializeRecipe(recipe);
	expect(output).toBe("> Hinweis zum Rezept.");
});

it("serializes a note with tokens", () => {
	const recipe = {
		metadata: {},
		sections: [
			{
				name: "",
				steps: [
					{
						tokens: [
							{ type: "text" as const, value: "Tipp: " },
							{
								type: "ingredient" as const,
								name: "Butter",
								amount: "50",
								unit: "g",
							},
							{ type: "text" as const, value: " vorher schmelzen." },
						],
						isNote: true,
					},
				],
			},
		],
	};
	const output = serializeRecipe(recipe);
	expect(output).toBe("> Tipp: @Butter{50%g} vorher schmelzen.");
});

it("roundtrips a recipe with notes", () => {
	const input = `> Ein kleiner Hinweis.

@Mehl{500%g} verrühren.`;
	const parsed = parseRecipe(input);
	const output = serializeRecipe(parsed);
	const reparsed = parseRecipe(output);
	expect(reparsed.sections[0].steps).toHaveLength(2);
	expect(reparsed.sections[0].steps[0].isNote).toBe(true);
	expect(reparsed.sections[0].steps[1].isNote).toBeUndefined();
});
```

**Step 2: Run tests to verify they fail**

Run: `cd packages/backend && npx vitest run src/parser/__tests__/serializer.test.ts`
Expected: FAIL — notes serialized as plain text without `>` prefix.

**Step 3: Commit**

```bash
git add packages/backend/src/parser/__tests__/serializer.test.ts
git commit -m "test: add failing serializer tests for note steps"
```

---

### Task 5: Implement note serialization

**Files:**
- Modify: `packages/backend/src/parser/serializer.ts`

**Step 1: Add `>` prefix for note steps**

In `serializeRecipe()`, in the step serialization loop, change:

```typescript
const stepText = step.tokens.map(serializeToken).join("");
parts.push(stepText);
```

to:

```typescript
const stepText = step.tokens.map(serializeToken).join("");
parts.push(step.isNote ? `> ${stepText}` : stepText);
```

**Step 2: Run tests to verify they pass**

Run: `cd packages/backend && npx vitest run src/parser/__tests__/serializer.test.ts`
Expected: All tests PASS

**Step 3: Run all backend tests**

Run: `cd packages/backend && npx vitest run`
Expected: All tests PASS

**Step 4: Commit**

```bash
git add packages/backend/src/parser/serializer.ts
git commit -m "feat: serialize note steps with > prefix"
```

---

### Task 6: Add `note` type to frontend API types

**Files:**
- Modify: `packages/frontend/src/api.ts:18-25`

**Step 1: Add `note` type to `RecipeDetail`**

The `steps` array in `RecipeDetail` needs an `isNote` flag. Change the `steps` type:

```typescript
steps: Array<{
	tokens: Array<
		| { type: "text"; value: string }
		| { type: "ingredient"; name: string; amount: string; unit: string }
		| { type: "timer"; name: string; duration: string; unit: string }
		| { type: "equipment"; name: string }
		| { type: "inlineComment"; value: string }
		| { type: "blockComment"; value: string }
	>;
	isNote?: boolean;
}>;
```

**Step 2: Commit**

```bash
git add packages/frontend/src/api.ts
git commit -m "feat: add isNote flag to frontend RecipeDetail type"
```

---

### Task 7: Display notes in StepList (RecipeDetail view)

**Files:**
- Modify: `packages/frontend/src/components/StepList.tsx`
- Modify: `packages/frontend/src/styles/detail.css`

**Step 1: Update StepList to render notes differently**

In `StepList.tsx`, change the step rendering. Replace the inner step mapping:

```typescript
{section.steps.map((step, stepIndex) => (
	<p key={stepKey(step, stepIndex)} className="step-paragraph">
```

with:

```typescript
{section.steps.map((step, stepIndex) => (
	<p
		key={stepKey(step, stepIndex)}
		className={
			step.isNote
				? "step-paragraph step-paragraph--note"
				: "step-paragraph"
		}
	>
```

**Step 2: Add CSS for note styling**

Add to `packages/frontend/src/styles/detail.css` at the end of the step list section (after `.step-paragraph`):

```css
.step-paragraph--note {
	border-left: 3px solid var(--color-comment);
	padding-left: 1rem;
	color: var(--color-comment);
	font-style: italic;
}
```

**Step 3: Commit**

```bash
git add packages/frontend/src/components/StepList.tsx packages/frontend/src/styles/detail.css
git commit -m "feat: display notes with blockquote styling in recipe detail"
```

---

### Task 8: Skip notes in CookMode step numbering

**Files:**
- Modify: `packages/frontend/src/views/CookMode.tsx`

**Step 1: Filter out notes in flattenSections**

In `CookMode.tsx`, the `flattenSections` function needs to skip note steps. Change:

```typescript
function flattenSections(sections: RecipeDetail["sections"]): CookStep[] {
	const result: CookStep[] = [];
	for (const section of sections) {
		for (let i = 0; i < section.steps.length; i++) {
			result.push({
				sectionName: section.name,
				tokens: section.steps[i].tokens,
				isFirstInSection: i === 0 && section.name !== "",
			});
		}
	}
	return result;
}
```

to:

```typescript
function flattenSections(sections: RecipeDetail["sections"]): CookStep[] {
	const result: CookStep[] = [];
	for (const section of sections) {
		let isFirst = true;
		for (let i = 0; i < section.steps.length; i++) {
			if (section.steps[i].isNote) continue;
			result.push({
				sectionName: section.name,
				tokens: section.steps[i].tokens,
				isFirstInSection: isFirst && section.name !== "",
			});
			isFirst = false;
		}
	}
	return result;
}
```

**Step 2: Commit**

```bash
git add packages/frontend/src/views/CookMode.tsx
git commit -m "feat: skip notes in cook mode step navigation"
```

---

### Task 9: Create NoteExtension for TipTap

**Files:**
- Create: `packages/frontend/src/tiptap/note-extension.ts`
- Create: `packages/frontend/src/tiptap/note-component.tsx`

**Step 1: Create note-extension.ts**

Create `packages/frontend/src/tiptap/note-extension.ts`:

```typescript
import { Node, mergeAttributes } from "@tiptap/core";
import { ReactNodeViewRenderer } from "@tiptap/react";
import { NoteComponent } from "./note-component.js";

declare module "@tiptap/core" {
	interface Commands<ReturnType> {
		note: {
			setNote: () => ReturnType;
		};
	}
}

export const NoteExtension = Node.create({
	name: "note",
	group: "block",
	content: "inline*",

	parseHTML() {
		return [{ tag: 'div[data-type="note"]' }];
	},

	renderHTML({ HTMLAttributes }) {
		return [
			"div",
			mergeAttributes(HTMLAttributes, {
				"data-type": "note",
				class: "note-block",
			}),
			0,
		];
	},

	addNodeView() {
		return ReactNodeViewRenderer(NoteComponent);
	},

	addCommands() {
		return {
			setNote:
				() =>
				({ commands }) => {
					return commands.setNode(this.name);
				},
		};
	},
});
```

**Step 2: Create note-component.tsx**

Create `packages/frontend/src/tiptap/note-component.tsx`:

```typescript
import { type NodeViewProps, NodeViewContent, NodeViewWrapper } from "@tiptap/react";

export function NoteComponent(_props: NodeViewProps) {
	return (
		<NodeViewWrapper className="note-block">
			<NodeViewContent />
		</NodeViewWrapper>
	);
}
```

**Step 3: Commit**

```bash
git add packages/frontend/src/tiptap/note-extension.ts packages/frontend/src/tiptap/note-component.tsx
git commit -m "feat: add TipTap NoteExtension as block node"
```

---

### Task 10: Register NoteExtension and add CSS

**Files:**
- Modify: `packages/frontend/src/tiptap/index.ts`
- Modify: `packages/frontend/src/styles/tiptap.css`

**Step 1: Export NoteExtension**

Add to `packages/frontend/src/tiptap/index.ts`:

```typescript
export { NoteExtension } from "./note-extension.js";
```

**Step 2: Find where extensions are registered in the editor and add NoteExtension**

Search for where the editor is created (uses `useEditor` or `new Editor`) and add `NoteExtension` to the extensions array.

**Step 3: Add CSS for note blocks**

Add to `packages/frontend/src/styles/tiptap.css`:

```css
/* Note blocks */
.note-block {
	border-left: 3px solid var(--color-comment);
	padding-left: 1rem;
	color: var(--color-comment);
	font-style: italic;
	margin-bottom: 0.75rem;
}
```

**Step 4: Commit**

```bash
git add packages/frontend/src/tiptap/index.ts packages/frontend/src/styles/tiptap.css
```

Find and modify the editor file that registers extensions:

```bash
git add <editor-file-with-useEditor>
git commit -m "feat: register NoteExtension and add editor styles"
```

---

### Task 11: Update cooklang-bridge for notes

**Files:**
- Modify: `packages/frontend/src/tiptap/cooklang-bridge.ts`

**Step 1: Update `cooklangToTiptapDoc` to handle `>` lines**

In the `cooklangToTiptapDoc` function, add note detection in the block mapping. Before the section regex check, add:

```typescript
// Note line
if (trimmed.startsWith(">") && !trimmed.startsWith(">>")) {
	const noteContent = trimmed.slice(1).trim();
	return {
		type: "note",
		content: parseCooklangTokens(noteContent),
	};
}
```

**Step 2: Update `tiptapDocToCooklang` to serialize notes**

In the `tiptapDocToCooklang` function, add handling for note nodes. Add before the paragraph content mapping:

```typescript
if (node.type === "note") {
	if (!node.content) return "> ";
	const inner = node.content
		.map((child) => {
			if (child.type === "text") return child.text ?? "";
			if (child.type === "ingredient") {
				const { name, amount, unit } = child.attrs ?? {};
				if (!amount && !unit) return `@${name}`;
				if (unit) return `@${name}{${amount}%${unit}}`;
				return `@${name}{${amount}}`;
			}
			if (child.type === "timer") {
				const { name, duration, unit } = child.attrs ?? {};
				if (name) return `~${name}{${duration}%${unit}}`;
				return `~{${duration}%${unit}}`;
			}
			if (child.type === "equipment") {
				const { name } = child.attrs ?? {};
				if (name?.includes(" ")) return `#${name}{}`;
				return `#${name}`;
			}
			if (child.type === "comment") {
				const { value } = child.attrs ?? {};
				return `[- ${value} -]`;
			}
			return "";
		})
		.join("");
	return `> ${inner}`;
}
```

**Step 3: Update `sectionsToTiptapDoc` to convert note steps**

In `sectionsToTiptapDoc`, change the step loop:

```typescript
for (const step of section.steps) {
	content.push({
		type: "paragraph",
		content: step.tokens.map(tokenToTiptapNode),
	});
}
```

to:

```typescript
for (const step of section.steps) {
	content.push({
		type: step.isNote ? "note" : "paragraph",
		content: step.tokens.map(tokenToTiptapNode),
	});
}
```

**Step 4: Commit**

```bash
git add packages/frontend/src/tiptap/cooklang-bridge.ts
git commit -m "feat: handle notes in cooklang-bridge conversion"
```

---

### Task 12: Add `/notiz` slash command

**Files:**
- Modify: `packages/frontend/src/tiptap/slash-commands.ts`

**Step 1: Add the slash command**

Add a new `InputRule` to the array in `slash-commands.ts`:

```typescript
new InputRule({
	find: /\/notiz\s$/,
	handler: ({ state, range, chain }) => {
		chain().deleteRange(range).setNote().run();
	},
}),
```

**Step 2: Commit**

```bash
git add packages/frontend/src/tiptap/slash-commands.ts
git commit -m "feat: add /notiz slash command"
```

---

### Task 13: Add Notiz button to EditorToolbar

**Files:**
- Modify: `packages/frontend/src/components/EditorToolbar.tsx`
- Modify: `packages/frontend/src/styles/editor.css`

**Step 1: Add insertNote function and button**

In `EditorToolbar.tsx`, add after `insertComment`:

```typescript
function insertNote() {
	editor?.chain().focus().setNote().run();
}
```

Add button after the Kommentar button:

```tsx
<button
	type="button"
	className="editor-toolbar__btn editor-toolbar__btn--note"
	onClick={insertNote}
	disabled={!editor}
>
	Notiz
</button>
```

Update the hint text to include `/notiz`:

```
Tipp: Tippe /zutat, /timer, /equipment, /kommentar oder /notiz um schnell einzufuegen
```

**Step 2: Add CSS for note button**

Add to `packages/frontend/src/styles/editor.css`:

```css
.editor-toolbar__btn--note {
	color: var(--color-comment);
	border-color: color-mix(in srgb, var(--color-comment) 40%, transparent);
}

.editor-toolbar__btn--note:hover:not(:disabled) {
	color: var(--color-comment);
	border-color: var(--color-comment);
	background: color-mix(in srgb, var(--color-comment) 10%, transparent);
}
```

**Step 3: Commit**

```bash
git add packages/frontend/src/components/EditorToolbar.tsx packages/frontend/src/styles/editor.css
git commit -m "feat: add Notiz button to editor toolbar"
```

---

### Task 14: Verify end-to-end and move issue to done

**Step 1: Run all backend tests**

Run: `cd packages/backend && npx vitest run`
Expected: All tests PASS

**Step 2: Build frontend**

Run: `cd packages/frontend && npm run build`
Expected: Build succeeds

**Step 3: Move issue to done**

```bash
mv _issues/004-notizen.md _issues/done/004-notizen.md
git add _issues/
git commit -m "chore: move notizen issue to done"
```
